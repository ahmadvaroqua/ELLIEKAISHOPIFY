{% paginate collection.products by settings.pagination_limit %}
  {% assign tag_count = collection.all_tags | size %}
  {% assign tag_threshold = 8 %}

  <div class="sixteen columns clearfix collection_nav">
    <h1 class="collection_title {% if settings.collection_tags and tag_count < tag_threshold %}collection_title_tags{% endif %}"><a href="{% if collection.handle == "all" %}/collections/all{% else %}{{ collection.url }}{% endif %}" title="{{ collection.title | escape }}">{{ collection.title }}</a></h1>
    {% if settings.collection_tags %}
      {% if tag_count < tag_threshold %}
        <ul class="collection_menu">
          <li>
            <a href="{% if collection.handle == "all" %}/collections/all{% else %}{{ collection.url }}{% endif %}">{% if current_tags %}All{% else %}<span class="active">All</span>{% endif %}</a>
          </li>
          {% for tag in collection.all_tags %}
            {% unless tag contains 'meta-related-collection-' %}
              <li>
                {{ tag | highlight_active_tag | link_to_tag: tag }}
              </li>
            {% endunless %}
          {% endfor %}
        </ul>
      {% endif %}
    {% endif %}

    {% if settings.collection_tags %}
      <select name="tag_filter" id="tag_filter" {% if tag_count >= tag_threshold %}style="display:block"{% endif %}>
        <option {% unless current_tags %}selected="selected"{% endunless %} value="{% if collection.handle == "all" %}/collections/all{% else %}{{ collection.url }}{% endif %}">All</option>
        {% for tag in collection.all_tags %}
          {% unless tag contains 'meta-related-collection-' %}
            <option {% if current_tags contains tag %}selected="selected"{% endif %} value="/collections/{% if collection.handle != blank %}{{ collection.handle }}{% else %}all{% endif %}/{{ tag | handleize }}">{{ tag }}</option>
          {% endunless %}
        {% endfor %}
      </select>
    {% endif %}
  </div>

  {% if collection.description != blank %}
    <div class="sixteen columns">
      <div class="section clearfix">
        {{ collection.description }}
      </div>
    </div>
  {% endif %}

    {% if collection.products.size == 0 %}
      <div class="sixteen columns">
        <div class="section clearfix">
          <p class="quote">No products found in this collection.</p>
        </div>
      </div>
    {% else %}
      {% assign products = collection.products %}
      {% assign products_per_row = settings.products_per_row %}
      {% include 'product-loop' %}
      {% include 'pagination' %}
    {% endif %}
{% endpaginate %}

<script type="text/javascript">
  // These are the current cookie values
  var consultant_cookie_value = $.cookie('consultant_id');
  var trunk_show_cookie_value = $.cookie('trunk_show_id');

  // These are the referral codes in the URL if present
  var consultant_url_value = $.url('?consultant_id');
  var trunk_show_url_value = $.url('?trunk_show_id');
  var refresh_url_value = $.url('?refresh');

  // Refresh
  if (refresh_url_value == 'true'){
    // console.debug("Refresh is true.");
    // Refresh is true
    // Delete all cookies
    $.removeCookie('consultant_id', { path: '/' });
    $.removeCookie('trunk_show_id', { path: '/' });
  }
  else {
    // console.debug("Refresh is false.");
    // Refresh is false
    // Leave existing cookies intact. If the URL contains consultant or trunk show
    // info, drop/update the cookie. From then on the cookies will live until
    // you go to http://shop.elliekai.com/collections/all?refresh=true

    // Consultant URL is not empty, drop a cookie
    if (consultant_url_value != null){
      // console.debug('Consultant URL is not empty, dropping cookie.');
      $.cookie('consultant_id', consultant_url_value, { expires: 1, path: '/' });
    }

    // Trunk Show URL is not empty, drop a cookie
    if (trunk_show_url_value != null){
      // console.debug('Trunk Show URL is not empty, dropping cookie.');
      $.cookie('trunk_show_id', trunk_show_url_value, { expires: 1, path: '/' });
    }

  }

  /*
  console.debug("-----------");
  console.debug('consultant_url_value: ' + consultant_url_value);
  console.debug('trunk_show_url_value: ' + trunk_show_url_value);
  console.debug('refresh_url_value: ' + refresh_url_value);
  console.debug("-----------");
  console.debug('consultant_cookie_value: ' + consultant_cookie_value);
  console.debug('trunk_show_cookie_value: ' + trunk_show_cookie_value);
  console.debug("-----------");
  */
</script>
